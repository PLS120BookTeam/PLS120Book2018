---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
# load packages for chapter

library(emmeans)
library(ggplot2)
library(dplyr)
library(kableExtra)
library(knitr)
library(tables)
library(pander)
library(multcomp)
library(agricolae)

```


# Treatment Structures and Comparisons {#chTrtstr}

## Learning Objectives for Chapter {#LearnObj12}
1. Identify the treatment in a factorial experiment
1. State the null and alternative hypotheses of a factorial experiment.
1. Define and compare simple and main effects in a factorial.
1. Given a graph of factorial experiment results, determine if there are main effects and/or interaction effects. 
1. Calculate PLSD confidence intervals for a pairwise comparison of means and determine if two means are significantly different based on the CIs. 
1. Design factorial treatment combinations to answer a research question.
1. Transform a real-world question into a null hypothesis about means.
1. Create linear combinations of means that address practical real-world questions.
1. Define statistical interaction and explain it graphically.
1. Test hypotheses involving more than one and more than 2 means.
1. Interpret result of ANOVA with factorial treatments.
1. Interpret a graph of a factorial experiment, including description of L, Q and C trends.
1. Given a set of treatments, formulate and test useful contrasts.
1. Determine if a linear combination of means is a contrast.
1. Create contrasts to estimate the value and variance of interactions.
1. Estimate the variance of a linear combination of means.
1. Make confidence intervals for linear combination of estimated means.
1. Calculate and use the Least Significant Difference (LSD) to test for differences among treatments.
1. Apply the Protected LSD and explain how it ameliorates the inflation of alpha?
1. Create linear combinations of estimated treatment means.
1. Create contrasts to answer research questions such as effects of treatments, linear and quadratic effects of continuous treatment variables.


## Pairwise Comparisons {#PairComp}

## Factorials {#Factorials}

Factorials are experiments where treatments have a special structure resulting from combining levels of different factors. The treatment structure allows us to assess the effects of several treatment factors as well as the interaction between factors. The concept of **interaction** is fundamental in statistics and in life in general and is treated in detail below. Let's concentrate on the factorial structure for now.


### Advantages of factorials

Consider that you have to study the effects of irrigation and fertilization with N on corn yield. You could take a simple approach and do one experiment forirrigation and another for nitrogen, or you could study both factor at the same time in a factorial experiment. Note that "factorial" refers to the way treatments are organized and it says nothing about the experimental design in terms of how treatments are assigned to experimental units.

Here we demonstrate two main advantages of factorials:

- abiliyt to detect interactions between factors, and
- much greater efficiency than separate experiments.

To show the advantage of a factorial, we first simulate two separate experiments and then a single combined experiment with both factors. By comparing the results we will be able to see that the factorial approach has advantages.

<br>

#### Effects of Irrigation alone

Using the simple approach, the experiment for irrigation includes two treatments: one or two irrigations. For this experiment, a moderate level of nitrogen of 160 lb/ac is selected. Treatments are repeated three times in each of two blocks (Table \@ref(tab:tblIrrigDat)). In this case we include replicates of treatments within blocks to have a total number of observations that will be comparable to case when we test both factors at once. The original data set has 20 observations, so we will simulate 12 observations ^[We use 12 instead of 10 for simplicity, to have the same number of replicates equal in all treatments. This is not absolutely necessary, but different sample sizes per treatment makes things a bit more complicated.] for the irrigation experiment and 10 observations for the nitrogen experiment.

<br>

```{r message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}

# Wheat yield data from page 137 of SG book

# IxN <- read.csv("IrrigationNitroFactorial.csv", header = TRUE)
IxN <- read.table(header = TRUE, text = "
Block Irrigation Nitrogen Yield
1 1 0 31.7
1 2 160 68.5
1 1 160 56.8
1 1 80 50
1 1 240 57.3
1 2 0 38.9
1 2 240 73.5
1 2 80 61.4
1 2 320 70.6
1 1 320 53.1
2 2 240 72.9
2 2 160 66.7
2 1 240 59.4
2 2 0 40
2 1 160 60.6
2 1 80 48.6
2 2 320 72.3
2 1 320 54.1
2 2 80 53.1
2 1 0 39.1
")

IxN$Block <- factor(IxN$Block)
IxN$Irrigation <- factor(IxN$Irrigation)
IxN$Nitrogen <- factor(IxN$Nitrogen)
IxN <- IxN[order(IxN$Block, IxN$Irrigation, IxN$Nitrogen), ]



# Get estimated parameters and use them to generate simulated data for single experiments.

set.seed(12)

ixn.m1 <- lm(Yield ~ Irrigation * Nitrogen + Block, data = IxN)

IrrigDat <- expand.grid(Block = levels(IxN$Block), 
                        Irrigation = factor(c(1,2)), 
                        Nitrogen = factor(160), 
                        rep = c(1:3))

IrrigDat$Yield <- predict(object = ixn.m1, 
                          newdata = IrrigDat) + 
   rnorm(dim(IrrigDat)[1], mean = 0, sd = summary(ixn.m1)$sigma)
```


```{r tblIrrigDat, echo= FALSE}

kable(IrrigDat, 
      caption = "Simulated data for a simple experiment to test the effect of irrigation on wheat yield.") %>% kable_styling(full_width = FALSE)

```
<br>

We analyze these data using the following model (Equation \@ref(eq:irrigMod1)), which is known to have the correct form because the data were simulated based on the same model. Note that the model does not mention the effect of nitrogen because the same dose of nitrogen was applied to all plots.
<br>

\begin{equation}
Y_{ijh} = \mu_{...} + \tau_i + B_j +  \epsilon_{ijh} \\[20pt]
\tau_i = \text{ effect of irrigation treatment with level i} \\
B_j = \text{ effect of block j} \\
\epsilon_{ijh} = \text{ random error in treatment i, block j and replicate h}
(\#eq:irrigMod1)
\end{equation}

<br>

```{r IrrigAnova, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}

irrig.m1 <- lm(Yield ~ Irrigation + Block, data = IrrigDat)

kable(anova(irrig.m1), 
      caption = "ANOVA table for irrigation effects on yield.",
      digits = c(0, 1, 1, 2, 5)) %>% 
   kable_styling(full_width = FALSE)

```

<br>

```{r IrrigEmmeans, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}

kable(emmeans(irrig.m1, "Irrigation"), 
      caption = "Effect of irrigation on wheat yield", 
      digits = c(0, 1, 2, 0, 2, 2)) %>% 
   kable_styling(full_width = FALSE)

```
<br>

The ANOVA table shows that there is a significant difference in yield between treatments. Table \@ref(tab:IrrigEmmeans) contains the estimated means for both irrigations and shows that yield is significantly greater with two than with a single irrigation. The precision of the estimates is reflected in both the MSE in the ANOVA table and in the width of the confidence intervals of the table of means, which is about `r round(2 * qt(p = 0.975, df = irrig.m1$df.residual) * sqrt(anova(irrig.m1)[3, 3] / 6), 2)` bushels/ac (1 bushel of wheat is equivalent to 60 lb). The width of the confidence interval is calculated as twice the product of the critical t value, which depends on the degrees of freedom of the residuals (dfe = 9), and the standard error, which is the square root of the MSE divided by the square root of the number of experimental units averaged to get each estimated mean. There were 12 experimental units equally divided between the two treatments in the experiment, so six experimental units were used for the average of each treatment.

```{r message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE, include=FALSE}
tcrit <- qt(p = 0.975, df = irrig.m1$df.residual)
MSE <- anova(irrig.m1)[3, 3]
```


\begin{equation}
\text{CI width } = 2 \ t_{dfe, \alpha} \ \sqrt{\frac{MSE}{r}} \\[20pt]
\text{where the number of plots averaged per treatment is } r = 6 \\[20pt]
dfe = `r irrig.m1$df.residual` \\[20pt]
t_{dfe, \alpha} = `r round(tcrit, 4)` \\[20pt]
\text{therefore, CI width } = 2 \times `r round(tcrit, 4)` \times `r round(sqrt(MSE / 6), 3)` = `r round(2 * tcrit * sqrt(MSE / 6), 3)`
\end{equation}


<br>

#### Effects of Nitrogen alone

Following with the simple approach of one factor at a time, we do a second experiment to determine the effect of nitrogen fertilization on wheat yield. Five equally-spaced doses of nitrogen (0, 80, 160, 240 and 320 lb/ac) are selected. For this experiment, one irrigation is used for all plots. The five treatments are replicated in each of two blocks, such that each treatment appears in a single experimental unit per block.

```{r message=FALSE, warning=FALSE, paged.print=FALSE, include=FALSE}

NitroDat <- expand.grid(Block = levels(IxN$Block), 
                        Irrigation = factor(1), 
                        Nitrogen = factor(c(0, 80, 160, 240, 320)))

set.seed(902)
NitroDat$Yield <- predict(object = ixn.m1, 
                          newdata = NitroDat) + 
   rnorm(dim(NitroDat)[1], mean = 0, sd = summary(ixn.m1)$sigma)

```


```{r tblNitroDat, echo= FALSE}

kable(NitroDat, 
      caption = "Simulated data for a simple experiment to test the effect of nitrogen on wheat yield.") %>% kable_styling(full_width = FALSE)

```
<br>

We analyze these data using the following model (Equation \@ref(eq:NitroMod1)), which is known to have the correct form because the data were simulated based on the same model. Note that the model does not mention the effect of irrigation because the same single irrigation was applied to all plots.

<br>

\begin{equation}
\begin{aligned}
Y_{ij} &= \mu_{...} + \tau_i + B_j + \epsilon_{ij} \\[20pt]
\tau_i &= \text{ effect of nitrogen treatment with level i} \\
B_j &= \text{ effect of block j} \\
\epsilon_{ij} &= \text{ random error in treatment i, block j}
\end{aligned}
(\#eq:NitroMod1)
\end{equation}

<br>

```{r NitroAnova, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}

nitro.m1 <- lm(Yield ~ Nitrogen + Block, data = NitroDat)

kable(anova(nitro.m1), 
      caption = "ANOVA table for nitrogen effects on yield.",
      digits = c(0, 1, 1, 2, 5)) %>% 
   kable_styling(full_width = FALSE)

```

<br>

```{r NitroEmmeans, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}

kable(emmeans(nitro.m1, "Nitrogen"), 
      caption = "Effect of nitrogen on wheat yield", 
      digits = c(0, 1, 2, 0, 2, 2)) %>% 
   kable_styling(full_width = FALSE)

```
<br>

The ANOVA table for the nitrogen experiment shows that there is a significant difference in yield between treatments. Table \@ref(tab:NitroEmmeans) contains the estimated means for nitrogen doses and shows that yield is highest when a dose of 160 lb N/ac is applied. Note that the reponse to nitrogen in not a straight line, and that the effect of adding 80 lb N/ac depends on how much was added already. An important part of this result is that more is not alway better when it comes to nitrogen and plants. Too much nitrogen has a negative effect on plant growth, and in wheat it is known to be detrimental to the metabolism necessary for grain filling. Too much nitrogen results in reduced antioxidant ability, which lead to increased lipied peroxidation [KongEtAl2017]. Moreover, wheat is unable to absorb all the applied nitrogen, which leads to nitrogen percolating into deeper soil layers and water contamination [DongEtAl2011]. A graph of the response to nitrogen levels reveals the non-linearity of the response and the reduction of yield for doses above 160 lb/ac (Figure \@ref(fig:nitroFig1)).

<br><br>

```{r nitroFig1, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE, fig.cap ="Effects of nitrogen fertilization level o wheat yield. Vertical error bars are confidence intervals."}

nitroMeans <- as.data.frame(emmeans(nitro.m1, "Nitrogen"))
nitroMeans$Nitrogen <- as.numeric(as.character(nitroMeans$Nitrogen))

ggplot(data = nitroMeans, aes(x = Nitrogen, y = emmean)) + 
   geom_line(size = 1.5) + 
   geom_point(size = 4) + 
   geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 5,
                 position = position_dodge(0.05)) + 
   labs(x = "Nitrogen (lb/ac)", y = "Grain Yield (bu/ac)")

```

<br><br>


Precision of mean estimates is reflected in both the MSE in the ANOVA table and in the width of the confidence intervals of the table of means, which is about `r round(2 * qt(p = 0.975, df = nitro.m1$df.residual) * sqrt(anova(nitro.m1)[3, 3] / 2), 2)` bushels/ac. Again, confidence interval width is calculated as twice the product of the critical t value, which depends on the degrees of freedom of the residuals (in this case dfe = 4), and the standard error, which is the square root of the MSE divided by the square root of the number of experimental units averaged to get each estimated mean. There were 10 experimental units equally divided between the 5 treatments in the experiment, so 2 experimental units were used for the average of each nitrogen treatment.


```{r message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE, include=FALSE}

tcrit <- qt(p = 0.975, df = nitro.m1$df.residual)

MSE <- anova(nitro.m1)[3, 3]

```

<br>

\begin{equation}
\text{CI width } = 2 \ t_{dfe, \alpha} \ \sqrt{\frac{MSE}{r}} \\[20pt]
\text{where the number of plots averaged per treatment is } r = 2 \\[20pt]
dfe = `r nitro.m1$df.residual` \\[20pt]
t_{dfe, \alpha} = `r round(tcrit, 4)` \\[20pt]
\text{therefore, CI width } = 2 \times `r round(tcrit, 4)` \times `r round(sqrt(MSE / 2), 3)` = `r round(2 * tcrit * sqrt(MSE / 2), 3)`
\end{equation}


If we base our irrigation and fertilization decisions in these two experiments we would decide to irrigate twice and apply 160 lb N/ac. As we will see below, it turns out that this is not the best decision possible, and that only a factorial experiment can reveal the optimal combination of irrigation and nitrogen because those two factors interact biologically and statistically.

<br>

#### Combined Effects of Irrigation and Nitrogen

Instead of two experiments, we could do a single one where all levels of irrigation are combined with all levels of nitrogen in a factorial treatment structure. Each treatment is replicated once in each of two blocks. The experiment has 5 levels of nitrogen x 2 levels of irrigation x 2 blocks = 20 plots or experimental units. This is 2 fewer than the two individuial experiments together.

```{r tblIxNDat, echo= FALSE}

tblixn <- cbind(IxN[IxN$Block == 1, 2:4],IxN[IxN$Block == 2, 4])

names(tblixn) <- c("Irrig", "Nitro", "Block 1", "Block 2")

kable(tblixn, 
      row.names = FALSE, 
      caption = "Wheat yield (bu/ac) in an experiment to test the joint effects of nitrogen (lb/ac) and irrigation (times).") %>% kable_styling(full_width = FALSE)

```
<br>

Data from the factorial experiment are analyzed using the model in Equation \@ref(eq:IxnMod1). The equation shows that each treatment effect is partitioned into nitrogen effect, irrigation effect and nitrogen by irrigation interaction. The interaction reflects the part of the response that is not explained by simply adding the individual effects of each factor.

<br>

\begin{equation}
\begin{aligned}
Y_{ijh} &= \mu_{...} + \tau_[ij] + B_j + \epsilon_{ij} \\[20pt]
\tau_{ij} &= \text{ effect of treatment with level i of nitrogen and level j of irrigation} \\
&= N_i + I_j + NI_{ij} \\
N_i &= \text{ effect of level i of nitrogen} \\
I_j &= \text{ effect of level j of irrigation} \\
IN_{ij} &= \text{ interaction effect of levels i and j} \\
B_j &= \text{ effect of block j} \\
\epsilon_{ij} = \text{ random error in treatment i, block j}
\end{aligned}
(\#eq:IxnMod1)
\end{equation}

<br>

```{r IxNAnova, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}

kable(anova(ixn.m1), 
      caption = "ANOVA table for nitrogen x irrigation factorial effects on yield.",
      digits = c(0, 1, 1, 2, 5)) %>% 
   kable_styling(full_width = FALSE)

```

<br>

Because we did the experiment using a factorial arrangewment of treatments, we have three types of comparisons we can do:

- compare average yield for levels of irrigation averaged over levels of nitrogen,
- compare average yield for levels of nitrogen averaged over levels of irrigation, and
- compare averages of individual treatments resulting from any two combinations of irrigation and nitrogen.

The tables of estimated means show that there are

```{r IxNEmmeans, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}

kable(emmeans(ixn.m1, "Nitrogen"), 
      caption = "Effect of nitrogen on wheat yield", 
      digits = c(0, 1, 2, 0, 2, 2)) %>% 
   kable_styling(full_width = FALSE)

kable(emmeans(ixn.m1, "Irrigation"), 
      caption = "Effect of nitrogen on wheat yield", 
      digits = c(0, 1, 2, 0, 2, 2)) %>% 
   kable_styling(full_width = FALSE)

```
<br>





## Control vs. Treatments {#CtlTrt}

## Linear, Quadratic and Cubic Trends {#LCQtrends}

## Contrasts {#Contrasts}

## Linear Combinations {#LinCombo}

## Exercises and Solutions {#ExSol12}

## Homework {#Hwk12}

## Laboratory Exercises

### Plant Sciences {#Lab12PLS}

Prepare an .Rmd document starting with the following text, where you substitute the corresponsing information for author name and date.

```
---
title: "Lab07 Factorial ANOVA and LSD"
author: "YourFirstName YourLastName"
date: "enter date here"
output: html_document
---
```

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

# install.packages(c("tables", "pander","lsmeans", "multcomp","agricolae"))

library(tables)
library(pander)
library(lsmeans)
library(multcomp)
library(agricolae)

```

#### Instructions

The same instructions for completion and submission of work used in previous labs applies here. Refer to previous labs for the details. 

For this lab you have to be familiar with the following sections of the textbook:

\@ref(chRcbd) RCBD without subsamples
\@ref(chTrtstr) Factorial Experiments
\@ref(label) Fisher's Protected LSD


In this exercise we analyze the data resulting from an experiment at the UC Davis Plant Sciences research fields. These are based on the **same experiment used in Lab 06**, but now we will consider that seeding and fertilizer are two **factors** that create the set of 6 treatments in a **factorial** treatment structure. We ignore the factor water for simplicity and because it did not cause any effects. The 6 treatments were applied in a **Completely Randomized Block Design** in which each of 6 treatments were applied randomly to 2 plots in each of 3 blocks for a total of 36 experimental units or plots.

Simulated block effects of 0.50, 0.25, and -0.75 were added to logMass observations in blocks 1, 2 and 3 to show block effects. Blocks were defined areas that were more or less homogeneous in soil and plant properties and that were contiguous. We will assume that the variances of the errors or residuals are the same in all treatments. Each observation represents the average mass of seeds produced by 4-5 medusahead plants (logMass). Data were log transformed as $logMass = log(SeedMass + 0.2)$ to achieve normality and equality of variances.


#### Part 1. Factorial ANOVA using R functions [ points]

##### 1a. Random assignment of treatments to plots

In a RCBD the treatments are assigned randomly to plots within blocks such that each treatment appears at least once in each block. Because we ignore the water factor, treatments will have 2 replicate plots in each block, one for each original level of the water factor. There are a total of 6 treatments that resulf from the combination each level of the factor "nitrogen" (n and N) with each of the three levels of the factor "seeding" (s, S and E). The treatments are identified by the two letters together. For example. NE is the treatment with addition of nitrogen and at the egde between naturalized annual and seeded native perennial grasses.

First, we pretend that the experiment is about to start and we need to assign treatments to experimental units. The random assignment of treatments to plots within blocks can be done using the '*'sample' R function. To preform the random assignment we start by creating a dataframe with a row for each treatment and a column for each factor. A new column called "Treatment" is created by pasting together the two letters that represent the corresponding level of the factor.

```{r}
# Read and understand the code in this part but do not type or modify anything.
# Create a data frame with all combinations of levels of the 2 factors. First, create treatment names for all 6 treatments. 

treat <- expand.grid(
  nitro = c("n", "N"), 
  seeding = c("s", "S", "E")
  )


# Create a column containing the treatment name in the data frame

treat$Treatment <- paste(
  treat$nitro, 
  treat$seeding, sep = ""
  )

```

In the second step, plots in each block are labeled with the numbers 1 through 12. We make a character vector with two copies of each treatment label, shuffle the order of treatment with 'sample' and column-bind the results with the plot labels. At this point, the objects called 'block1', 'block2' and 'block3' list the plot number and the treatment it should receive.


```{r}
# Number the 12 plots in each block 1 through 12, then shuffle the treatment names and assign to plots of each block.
# The sample() function is used to create a vector that has each treatment randomly assigned to each block twice, because there are two plots for each treatment in each block.

# Plots 1-12 of each block get:

(block1 <- cbind(1:12, sample(c(treat$Treatment, treat$Treatment))))


(block2 <- cbind(1:12, sample(c(treat$Treatment, treat$Treatment))))


(block3 <- cbind(1:12, sample(c(treat$Treatment, treat$Treatment))))

```

##### 1.b Add columns with factor levels to the data

Treatments were applied, plantts grown and measured. Data were collected and organized, and we enter them below. Because the data have the labels for the original treatments, we need to split the labels into the columns that correspond to nitrogen and seeding treatment. In order to analyze the experiment as a factorial of nitrogen x seeding, each factor has to be in a separate column.

```{r}
# Read and understand the code in this part but do not type or modify anything.
# Read data (seedF for "factorial")

# seedF <- read.csv(file = "Lab07SeedMassData.txt", header = TRUE)

seedF <- read.table(header = TRUE, text = "
Treatment  block  logMass
wnE  Block1  -0.210836005431437
wNE  Block1  1.55288938986704
WnE  Block1  0.055235139345024
WNE  Block1  0.835167804254832
wns  Block1  1.24627323200302
wnS  Block1  0.540066519204629
wNs  Block1  1.57199447282598
wNS  Block1  1.23870355136554
Wns  Block1  0.986995928669204
WnS  Block1  -0.170749893385349
WNs  Block1  0.664136397253749
WNS  Block1  0.736888706368722
wnE  Block2  0.041449411568171
wNE  Block2  1.428708818124
WnE  Block2  0.319992367391131
WNE  Block2  1.03098409320956
wns  Block2  0.643797294741899
wnS  Block2  -0.511211922892043
wNs  Block2  1.84080033644501
wNS  Block2  0.813650468511317
Wns  Block2  1.69986757761409
WnS  Block2  -0.154140967169852
WNs  Block2  1.423732115253
WNS  Block2  0.2968644855256
wnE  Block3  -0.655926955677754
wNE  Block3  -0.27934035269992
WnE  Block3  -0.5542030003591
WNE  Block3  -1.12888399571028
wns  Block3  0.45627765803375
wnS  Block3  -1.04875645623447
wNs  Block3  0.49759250163951
wNS  Block3  -0.097792008066854
Wns  Block3  -0.513584856362292
WnS  Block3  -1.36796547632004
WNs  Block3  1.02290365359422
WNS  Block3  -0.527897010482484
")

```

The two factor columns are sufficient to perform the analysis using preexisting R functions for factorial treatment combinations, but to do the calculations using only "basic" R functions (we refer to this as "by hand") we need a new column that contain labels for all 12 treatments. We create the colkumn by pasting the letters for nitrogen and seeding levels, make it into a factor, and add it to the data frame. Recall that a factor is a special type of column in data frames that behaves as a categorical variable with a certain set of possible values. The same column of strings could be set to be a character vector, in which case it would not have recognizable levels. You can explore this by running 'levels(seedF\$NStreat)' and then 'levels(as.character(seedF\$NStreat))'

```{r}
# Add columns $nitro and $seeding to the data, to show the levels for each factor.

seedF$nitro <- factor(substr(seedF$Treatment, 2, 2))

seedF$seeding <- factor(substr(seedF$Treatment, 3, 3))

# Add column NStreat for treatments resulting from nitro and seeding combinations.

seedF$NStreat <- factor(paste(seedF$nitro, seedF$seeding, sep = ""))

```


##### 1.c Perform a test of the Ho that all treatment means are equal.

For this part you need to test the null hypotheses that:
- there are no interactions between nitrogen and seeding,
- there are no "main effects" of nitro or seeding.

"Main effects" refers to the overall effect of a factor averaged over all levels of other factors. "Simple effects" are the effects of one factor for a given individual level of another factor. For example, the main effect of S for level n is:

$$\bar{Y}_{nS}$$

We do these tests with an ANOVA that partitions all variation (sum of squares) in the response variable (logMass) into Block, Treatment and Error, and then partition the Treatment variation into main effect of nitro, main effect of seeding, and the interaction between nitro and seeding (nitro x seeding).


```{r}

# First do the ANOVA ignoring the treatment factorial structure.

# This yields the first partition of SS

rcbd.mod <- lm(formula = logMass ~ NStreat + block, data = seedF)

pander(anova(rcbd.mod))

# Now, analyze the same data, this time partitioning the Treatment SS according to a factorial treatment structure.

rcbdF.mod <- lm(formula = logMass ~ nitro * seeding + block, data = seedF)

# complete the code below to make an ANOVA table for the same data partitioning the Treatment SS according to factorial, as above:

pander(anova(rcbdF.mod))


```


Questions:

a) Report MSE in the RCBD and RCBDF models.

b) State the null hypothesis for the main effects of N in the RCBDF model.

c) State the null hypothesis for the main effects of seeding in in the RCBDF model.

c) Do we reject or fail to reject the following null hypothesis for the RCBDF model?

Ho: There is no interaction between nitrogen and seeding affecting medusahead seed mass?


#### Part 2. Factorial ANOVA detailed calculations [ points]

Create a new column in the data for each of the following:
- overall average
- nitro treatment average
- nitro effect = nitro average - overall average
- seeding treatment average
- seeding effect = seeding average - overall average
- overall average + nitro effect + seeding effect
- nitro x seeding average
- nitro x seeding interaction = 
  = nitro x seeding average - (overall average + nitro effect + seeding effect)
- block average
-block effect = block average - overall average
- residual


Then calculate the sum of squares and degrees of freedom for nitro effect, seeding effect, interaction and residuals. Make sure that the numbers match the results from the previous section.


```{r}

# First calculate the average medusahead seed mass per factor and add to a data frame

# Type the column name of the response variable after the dollar sign:

seedF$overall.avg <- mean(seedF$logMass) 

nitro.avg <- aggregate(formula = logMass ~ nitro, 
                       data = seedF, 
                       FUN = mean)

names(nitro.avg)[2] <- "nitro.avg"

seedF <- merge(seedF, nitro.avg)

# Type the function for calculating averages:

seed.avg <- aggregate(formula = logMass ~ seeding, 
                      data = seedF, 
                      FUN = mean)

names(seed.avg)[2] <- "seed.avg"

seedF <- merge(seedF, seed.avg)


nitro.seed.avg <- aggregate(formula = logMass ~ nitro + seeding, 
                      data = seedF, 
                      FUN = mean)

names(nitro.seed.avg)[3] <- "nitro.seed.avg"

seedF <- merge(seedF, nitro.seed.avg)


# Create a vector called block.avg to aggregate the response variable by block and calculate the means of each block

block.avg <- aggregate(formula = logMass ~ block, 
                       data = seedF, 
                       FUN = "mean")

names(block.avg)[2] <- "block.avg"

seedF <- merge(seedF, block.avg)


# Second, calculate the effects and residuals

seedF$nitro.fx <- seedF$nitro.avg - seedF$overall.avg

# Type the vector name for the average of the seeded/unseeded treatment:

seedF$seed.fx <- seedF$seed.avg - seedF$overall.avg 

seedF$nitro.seed.fx <- with(seedF, nitro.seed.avg - (overall.avg + nitro.fx + seed.fx))

seedF$block.fx <- seedF$block.avg - seedF$overall.avg

seedF$resdl <- with(seedF, 
                    logMass - 
                       overall.avg - 
                       nitro.fx - 
                       seed.fx - 
                       nitro.seed.fx - 
                       block.fx)


# Finally, type your equations to calculate the sum of squares.

(SSnitro <- sum(seedF$nitro.fx ^ 2))

(SSseed <- sum(seedF$seed.fx ^ 2))

(SSnitro.seed <- sum(seedF$nitro.seed.fx ^ 2))

(SSblock <- sum(seedF$block.fx ^ 2))

(SSresdl <- sum(seedF$resdl ^ 2))

# HINT: check your answers of the SS with the anova table in Part1. It should be the same if your calculations are correct:

pander(anova(rcbdF.mod)) 


```


#### Part 3. Multiple comparison of means using Fisher's PLSD [ points]

Fisher’s Protected Least Significant Difference is the LSD that is applied only if the overall F test is significant. In this section you need to calculate the Least Significant differences for nitro, seeding and nitro x seeding levels. For each one, construct a table that shows the means that are NOT significantly different connected by a common letter.

``` {r}
# First, use the LSD.test() function of the agricolae package.


LSD.test(rcbdF.mod, "nitro", group = TRUE, console = TRUE)


LSD.test(rcbdF.mod, "seeding", group = TRUE, console = TRUE)


LSD.test(rcbdF.mod, c("nitro", "seeding"), group = TRUE, console = TRUE)


# Second, calculate the LSD's and CI's "by hand."
# Hint: check your answers of LSD with the lsd test table. It should be the same if your calculations are correct.

(dfe.rcbd.F <- 36 - 1 - 2 - 2 - 2 - 1)
(t.critical <- qt(0.975, dfe.rcbd.F))
(MSE.rcbd.F <- SSresdl / dfe.rcbd.F)


# nitrogen
(se.nitro <- sqrt(MSE.rcbd.F / (length(seedF$logMass) / length(levels(seedF$nitro)))))
(LSD.nitro <- t.critical * sqrt(2) * se.nitro)


# seeding
(se.seed <- sqrt(MSE.rcbd.F / (length(seedF$logMass) / length(levels(seedF$seeding)))))

# Type your equation and calculate the LSD for seeding.
(LSD.seed <- t.critical * sqrt(2) * se.seed)


# nitrogen x seeding
(se.nitro.seed <- sqrt(MSE.rcbd.F / 
                         (length(seedF$logMass) / 
                            (length(levels(seedF$nitro)) * 
                            length(levels(seedF$seeding))))))

# Type your equation and calculate the LSD for nitro * seeding
(LSD.nitro.seed <- t.critical * sqrt(2) * se.nitro.seed)


```


Question Read the last lsd table and answer following questions:.

a) Do treatments “n:s” and “N:s” differ? 

b) Do treatments “n:s” and “N:E” differ? 

c) Do treatments “n:s” and “n:E’ differ? 





### Animal Sciences {#Lab12ANS}


